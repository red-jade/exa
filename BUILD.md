# 𝔼𝕏𝔸 Build System

## EXA Client Build

Client applications that include EXA libraries 
should use the standard `mix` dependency format
for tagged releases on github.

The client `mix.exs` just refers to the labelled versions
of a consistent set of released EXA libraries,
grounded in the `exa_core` library.

For example:

`{:exa_core, [git: "https://github.com/red-jade/exa_core.git", tag: "v0.3.2"]}`

Clients do not use the umbrella `exa` project.

## EXA Library Build

The EXA platform contains a custom _umbrella_ build system
for all EXA libraries.

### Umbrella Project

The `exa` repo contains a shared mix utility module
to read command line arguments and environment variables,
then generate EXA library dependencies. 

  Repo:     exa
  File:     mix_util.ex
  Module:   MixUtil
  Function: exa_deps/2

The `MixUtil` module has the hardcoded definition
of the current set of consistent
version tags for all EXA libraries.

The public interface used by EXA library builds is `exa_deps/2`,
which takes two arguments:
- the (atom) name of the calling EXA library
- list of (atom) names for dependencies, including
  both EXA libraries and default support libraries
  
The `exa_deps` function will convert each name
into a full mix dependency tuple.
  
### Build Scope

There are four _scopes_ to build exa libraries:
 - `local` builds using current local versions 
    checked-out in sibling directories with paths `../exa_xxx`
 - `main` builds from github main branches
 - `tag`  builds from github tagged releases 
    generated from values defined in the exa `MixUtil` module
    and then written to the local `deps.ex` file
 - `rel` (default) builds from github tagged releases 
    read from the local checked-in `deps.ex` file

The build scope is determined in this order:
- `--build scope` argument to the mix task
  e.g. `mix compile --build local`
- `EXA_BUILD` shell environment variable
  e.g. `$ export EXA_BUILD=local`
- fallback default to `rel`

The development of a new platform release will typically 
go through phases `local` -> `tag` -> `rel`.

Clients of EXA libraries should _not_ set the scope.
The default value of `rel` means each EXA library can 
build without depending on the `exa` umbrella utilities.
The EXA library build will just use its local checked-in `deps.ex` file.

### External Dependencies

The current set of default dev/test support libraries is:
- `dialyxir` typechecking
- `ex_doc` documentation
- `benchee` benchmarking

### EXA Library 

All individual `exa_xxx` repos contain:
- boilerplate in the `mix.exs` project file,
  to bootstrap from the `exa` project
- an autogenerated checked-in `deps.ex` file
  to record the actual tagged dependencies
  
The `mix_util.exs` will fetch or generate dependencies as follows:

- If the `EXA_BUILD` environment variable is unset, or set to `"rel"`,
  then read dependencies from the `deps.ex` file.
  
- Else if the `exa` bootstrap dependency has been fetched 
  then compile the `exa/mix_util.ex` file 
  and call the `exa_deps` function to build dependencies.
  
- Otherwise, assume it is a bootstrap phase,
  and just return the `exa` dependency.

### Building An EXA Library

**To bootstrap an `exa_xxx` library build,**<br>
**you must update dependencies twice.**

One way to start a build is:
```
  $ mix deps.update exa
  $ mix deps.get
```




